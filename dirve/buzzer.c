#include "buzzer.h"
#include "stdint.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"
#include "FreeRTOS.h"
#include "task.h"
#include "main.h"
#include "cmsis_os.h"
const uint8_t gu_yong_zhe[] = {
	5,10,10,5,5,9,9,16,8,8,8,9,10,5,5,16,//想去远方的山川，想去海边看海鸥
6,8,8,6,5,10,10,16,9,8,8,6,9,16,//不管风雨有多少，有你就足够
5,10,10,5,5,9,9,16,8,8,8,6,5,10,10,16,//喜欢看你的嘴角，喜欢看你的眉梢
6,11,11,6,5,10,10,16,9,8,8,6,8,16,//白云挂在那蓝天，像你的微笑
5,12,5,5,12,5,9,16,8,6,8,8,8,10,12,16,//你笑起来真好看，像春天的花一样！
8,6,8,8,8,13,12,10,9,8,6,8,8,10,9,16,//把所有的烦恼，所有的忧愁，统统都吹散
5,12,5,5,12,5,9,16,8,6,8,8,13,12,16,//你笑起来真好看，像夏天的阳光
8,8,8,13,12,10,9,8,6,8,8,9,8,16,//整个世界全部的时光，美得像画卷。
};
const uint8_t beat[] = {
	4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,//想去远方的山川，想去海边看海鸥
4,4,4,4,4,4,4,4,4,4,4,4,8,4,//不管风雨有多少，有你就足够
4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,//喜欢看你的嘴角，喜欢看你的眉梢
4,4,4,4,4,4,4,4,4,4,4,4,8,4,//白云挂在那蓝天，像你的微笑
4,4,2,2,4,4,4,4,4,4,2,2,4,4,8,4,//你笑起来真好看，像春天的花一样！
4,4,2,2,4,4,4,4,4,4,4,4,4,4,8,4,//把所有的烦恼，所有的忧愁，统统都吹散
4,4,2,2,4,4,4,4,4,4,4,4,4,8,4,//你笑起来真好看，像夏天的阳光
4,4,4,4,4,4,4,4,4,4,4,4,8,4,//整个世界全部的时光，美得像画卷。
};
const float pitch_name_frequency[21] = {
	//??
	//1		2		3		4		5		6		7
	261.63,	293.67,	329.63,	349.23,	391.99,	440,	493.88,//0-6
	//??
	//1		2		3		4		5		6		7
	532.25,	587.33,	659.25,	698.46,	783.99,	880,	987.76,//7-13
	//??
	//1		2		3		4		5		6		7
	1046.50,1174.66,1318.51,1396.92,1567.98,1760,	1975.52//14-20
};

void play_music(void)
{
	uint32_t i, delay_time, tune;
	for(i=0;i<(sizeof(gu_yong_zhe)/sizeof(gu_yong_zhe[0]));i++)
	{
		delay_time = beat[i] * 250; //250ms 1/4?, 1s 1?
		if(gu_yong_zhe[i] != 21) // ?????
		{
			tune = (uint32_t)84*1000*1000/pitch_name_frequency[gu_yong_zhe[i]];
//			__HAL_TIM_SetAutoreload(&htim2, tune); // ????????
			TIM2->ARR = tune; // ????
//			__HAL_TIM_SetCompare(&htim2, TIM_CHANNEL_1, tune/2); // ????????
			TIM2->CCR1 = tune/2; // ????50%
			HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);
			vTaskDelay(delay_time); // ??????
			HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);
			__HAL_TIM_SetCounter(&htim2, 0); // CNT?????0,???????
		}
		else // ????
		{
			HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);
			vTaskDelay(delay_time);
		}
	}
}


const uint16_t freqTable[] = { // 音符频率表，单位 Hz
    262, 294, 330, 349, 392, 440, 466, 494, 523, 554, 587, 622,
    659, 698, 740, 784, 831, 880, 932, 988, 1047, 1109, 1175, 1245
};

unsigned char gyz[] = {  
    122,27,121,26,122,27,121,26,122,27,121,26,120,  
    143,140,110,111,112,111,143,130,111,112,111,112,113,36,111,36,111,36,111,122,121,47,140,  
    143,140,111,112,111,143,140,111,112,111,112,113,36,111,36,111,36,111,123,122,47,140,  
    16,111,136,116,116,115,126,116,115,116,115,116,115,143,140,16,111,136,116,116,115,116,115,137,117,117,116,127,126,143,  
    120,113,115,113,132,113,132,113,132,113,115,113,115,113,132,113,132,113,142,120,111,112,123,26,121,123,132,113,112,121,46,140,  
    116,117,211,212,117,211,221,211,117,211,212,117,211,221,211,212,213,212,213,212,223,213,212,223,225,223,  
    116,117,211,212,117,211,221,211,117,211,212,117,211,221,211,212,213,212,213,212,223,213,212,223,225,223,225,  
    233,215,233,215,213,215,216,213,225,225,233,215,233,215,  
    213,215,216,213,225,215,215,213,222,222,211,223,232,222,221,146,140,215,215,213,222,222,211,233,222,222,221,146,140,140,  
    116,115,136,115,116,115,116,115,126,116,115,116,115,116,115,143,140,116,115,136,115,116,115,116,115,137,117,117,116,117,116,143,140,  
    113,115,113,132,113,132,113,132,113,115,113,115,113,132,113,132,113,142,120,111,112,123,126,221,223,232,213,212,231,166,120,  
};

const uint32_t durations[] = {
    500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500,500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500,500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500// 你可以继续调整时长
};

void Set_Buzzer_Frequency(uint16_t frequency) {
    uint32_t period = 1000000 / frequency;  // 计算定时器周期
    __HAL_TIM_SET_AUTORELOAD(&htim2, period - 1);  // 设置定时器周期
}
void Delay(uint32_t time) {
    vTaskDelay(time);  // 使用 HAL 库的延时函数
}
void Play_Melody(void) {
   
TIM2->ARR=72-1;
TIM2->CCR1 = 1000000 / 1000 - 1;
    uint8_t noteIndex = 0;

    while (gyz[noteIndex] != 0xFF) {  // 如果是有效音符
        uint8_t note = gyz[noteIndex];
        uint16_t frequency = freqTable[note];

        Set_Buzzer_Frequency(frequency);  // 设置音符频率

        // 启动蜂鸣器
        HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);

        // 延时控制音符时长
        Delay(durations[noteIndex]);

        // 关闭蜂鸣器
        HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);

        // 延时控制音符之间的间隔
        Delay(50);

        noteIndex++;
    }
}
void non_Buzzer_Test(void *argument){

	for(;;)
	play_music();
//    Play_Melody();
}
